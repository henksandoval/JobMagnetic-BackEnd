trigger: none

pool:
  vmImage: 'ubuntu-latest'

resources:
  pipelines:
    - pipeline: BuildPipelineArtifacts
      source: Backend/API/ContinuousIntegration
      trigger:
        branches:
          include:
            - main

variables:
  projectId: '4c1f4cba-da43-4422-a077-8b7a47bb1cf2'
  buildPipelineId: '69'
  webAppName: 'JobMagneticAPIDev'
  azureConnection: 'Azure Resource Manager Connection'
  dockerImageRepo: 'jobmagnetic/backend'
  acrName: 'hasacr.azurecr.io'
  resourceName: 'HasDev'

stages:
  - stage: Deploy
    displayName: 'Deploy to DEV'
    jobs:
      - deployment: Deploy
        environment: 'DeployDev'
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/deploy-template.yml
                  parameters:
                    projectId: '$(resources.pipeline.BuildPipelineArtifacts.projectID)'
                    pipelineId: '$(resources.pipeline.BuildPipelineArtifacts.pipelineID)'
                    runId: '$(resources.pipeline.BuildPipelineArtifacts.runID)'
                    artifactName: 'Api'
                    targetPath: '$(Pipeline.Workspace)/downloaded_artifact'
                    appServiceName: 'jobmagnetic-webapi-dev'
                    azureSubscription: $(azureServiceConnection)
                    imageRepository: $(dockerImageRepo)
                    containerRegistry: $(acrName)
                    resourceGroupName: $(resourceName)
